name: deploy

on:
  schedule:
    - cron: '33 3 * * 1-5'
  workflow_dispatch:

jobs:

  build-push-release:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: permiss√£o para executar mvn
        run: chmod +x mvnw

      - name: calcular nova vers√£o
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "major:"
          minor_pattern: "feat:"
          version_format: "${major}.${minor}.${patch}"

      - name: atualizar pom.xml
        run: |
          ./mvnw versions:set -DnewVersion=${{ steps.version.outputs.version }} -DgenerateBackupPoms=false

      - name: gerar pagina html
        run: |
          mkdir -p src/main/resources/static
          echo "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body><h1>Vers√£o: ${{ steps.version.outputs.version }}</h1><h2>Data de deploy: $(TZ='America/Sao_Paulo' date +'%d/%m/%Y √†s %H:%M:%S')</h2></body></html>" > src/main/resources/static/deploy.html

      - name: upload html para debug
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy.html
          path: src/main/resources/static/deploy.html

      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

      - name: criar tag
        if: github.ref == 'refs/heads/main'
        run: |
          git tag v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }}

      - name: criar release no github
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}]
          body: Release feito automaticamente atrav√©s do workflow deploy.yml usando Github Actions.
          draft: false
          prerelease: false
          generate_release_notes: true
          files: target/*.jar

      - name: login no docker hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: build e push da docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: | 
            ${{ secrets.DOCKERHUB_USERNAME }}/artigo-eventos:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/artigo-eventos:${{steps.version.outputs.version }}

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build-push-release
    runs-on: ubuntu-latest
    steps:
      - name: deploy na VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            docker stop artigo-eventos || true
            docker rm artigo-eventos || true
            
            # Forces the download of the new 'latest' image
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/artigo-eventos:latest
            
            docker run -d \
              --name artigo-eventos \
              -p 80:8080 \
              -v /home/${{ secrets.VM_USERNAME }}/app-data:/app/data \
              -e SPRING_DATASOURCE_URL=jdbc:sqlite:/app/data/eventos.db \
              -e FILE_UPLOAD_DIR=/app/data/uploads \
              ${{ secrets.DOCKERHUB_USERNAME }}/artigo-eventos:latest

  notify:
    name: notificar discord
    runs-on: ubuntu-latest
    needs: [ build-push-release, deploy ]
    if: always()
    steps:
      - name: enviar mensagem
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            **üì¢ Workflow de deploy acabou de rodar**
            branch: `${{github.ref}}`
            
            **üì¶ vers√£o:** `${{ needs.build-push.outputs.version || 'N/A' }}`
            
            jobs:
            **‚û°Ô∏è build-push-release:** ${{ needs.build-push-release.result }}
            **‚û°Ô∏è deploy:** ${{ needs.deploy.result }}
            
            üîó [verificar execu√ß√£o](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})